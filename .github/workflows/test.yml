name: Run Tagged Tests

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Etiqueta de los escenarios a correr (ej: @QR)'
        required: false
        default: '@QR and @Desc'
  # schedule:
  #   - cron: "0 1 * * 1,3"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure CodeArtifact authentication
        run: |
          # Obtener token de CodeArtifact
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain td \
            --region ${{ secrets.AWS_REGION }} \
            --query authorizationToken \
            --output text)
          
          # Obtener URL del repositorio
          CODEARTIFACT_REGISTRY=$(aws codeartifact get-repository-endpoint \
            --domain td \
            --repository backend-shared-libs \
            --format npm \
            --region ${{ secrets.AWS_REGION }} \
            --query repositoryEndpoint \
            --output text)
          
          # Configurar .npmrc
          echo "registry=${CODEARTIFACT_REGISTRY}" > ~/.npmrc
          echo "${CODEARTIFACT_REGISTRY#https:}:_authToken=${CODEARTIFACT_AUTH_TOKEN}" >> ~/.npmrc
          echo "@md:registry=${CODEARTIFACT_REGISTRY}" >> ~/.npmrc
          
          # Verificar configuraciÃ³n
          echo "=== ConfiguraciÃ³n .npmrc ==="
          cat ~/.npmrc

      - name: Install dependencies
        run: npm install

      - name: Run Cucumber tests by tag
        continue-on-error: true
        run: |
          TAGS="${{ github.event.inputs.tag }}"
           if [ -z "$TAGS" ]; then
             TAGS="(@QR and @Smoke) or (@Sintetico and @Smoke)"
           fi

           echo "Running scenarios with tags: $TAGS"
           npx cucumber-js --tags "$TAGS" --format json:cucumber-report.json
           node reporter.js

      # ðŸ†• CREAR RESUMEN PERSONALIZADO DE TESTS
      - name: Generate Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Resumen de Tests" >> $GITHUB_STEP_SUMMARY

          if [ -f cucumber-report.json ]; then
            # Analizar resultados con Node.js
            cat > analyze-results.js << 'EOF'
            const fs = require('fs');
            
            try {
              const report = JSON.parse(fs.readFileSync('cucumber-report.json', 'utf8'));
              
              let totalScenarios = 0;
              let passedScenarios = 0;
              let failedScenarios = 0;
              let totalSteps = 0;
              let passedSteps = 0;
              let failedSteps = 0;
              let skippedSteps = 0;
              let totalDuration = 0;
              
              const failedTests = [];
              
              report.forEach(feature => {
                if (feature.elements) {
                  feature.elements.forEach(scenario => {
                    totalScenarios++;
                    let scenarioFailed = false;
                    
                    if (scenario.steps) {
                      scenario.steps.forEach(step => {
                        totalSteps++;
                        
                        if (step.result) {
                          if (step.result.duration) {
                            totalDuration += step.result.duration;
                          }
                          
                          switch (step.result.status) {
                            case 'passed':
                              passedSteps++;
                              break;
                            case 'failed':
                              failedSteps++;
                              scenarioFailed = true;
                              break;
                            case 'skipped':
                              skippedSteps++;
                              break;
                          }
                        }
                      });
                    }
                    
                    if (scenarioFailed) {
                      failedScenarios++;
                      failedTests.push({
                        feature: feature.name || 'Feature sin nombre',
                        scenario: scenario.name || 'Escenario sin nombre'
                      });
                    } else {
                      passedScenarios++;
                    }
                  });
                }
              });
              
              const duration = Math.round(totalDuration / 1000000); // nanosegundos a ms
              const successRate = totalScenarios > 0 ? Math.round((passedScenarios / totalScenarios) * 100) : 0;
              
              // Generar tabla de resumen
              console.log('| MÃ©trica | Valor |');
              console.log('|---------|-------|');
              console.log(`| ðŸ“Š **Escenarios Totales** | ${totalScenarios} |`);
              console.log(`| âœ… **Escenarios Exitosos** | ${passedScenarios} |`);
              console.log(`| âŒ **Escenarios Fallidos** | ${failedScenarios} |`);
              console.log(`| ðŸ“ˆ **Tasa de Ã‰xito** | ${successRate}% |`);
              console.log(`| ðŸ”§ **Steps Totales** | ${totalSteps} |`);
              console.log(`| â±ï¸ **DuraciÃ³n Total** | ${duration}ms |`);
              console.log('');
              
              if (failedTests.length > 0) {
                console.log('### âŒ Tests Fallidos:');
                console.log('');
                failedTests.forEach(test => {
                  console.log(`- **${test.feature}** â†’ ${test.scenario}`);
                });
                console.log('');
              }
              
              if (failedScenarios === 0) {
                console.log('### ðŸŽ‰ Â¡Todos los tests pasaron exitosamente!');
              }
              
              // Generar archivo de estado para GitHub
              fs.writeFileSync('test-status.txt', failedScenarios > 0 ? 'FAILED' : 'PASSED');
              
            } catch (error) {
              console.log('âŒ Error analizando resultados:', error.message);
            }
          EOF

            node analyze-results.js >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No se encontrÃ³ cucumber-report.json" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cucumber-html-report
          path: |
            cucumber-report.html
            reports/
            cucumber-report.json
