# name: Run Tagged Tests

# on:
#   workflow_dispatch:
#     inputs:
#       tag:
#         description: "Etiqueta de los escenarios a correr (ej: @QR)"
#         required: false
#         default: "@QR and @Desc"

# jobs:
#   test:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repo
#         uses: actions/checkout@v4

#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "18"

#       - name: Install dependencies
#         run: npm install

#       - name: Run Cucumber tests by tag
#         continue-on-error: true
#         run: |
#           echo "Running scenarios with tag ${{ github.event.inputs.tag }}"
#           npx cucumber-js --tags "${{ github.event.inputs.tag }}" --format json:cucumber-report.json
#           node reporter.js

#       - name: Upload report artifact
#         uses: actions/upload-artifact@v4
#         if: always()
#         with:
#           name: cucumber-html-report
#           path: |
#             cucumber-report.html
#             pdf-report/  # si tambiÃ©n estÃ¡s generando el PDF aquÃ­

#       - name: Authenticate to Google Cloud
#         uses: google-github-actions/auth@v2
#         if: always()
#         with:
#           credentials_json: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_KEY }}

#       - name: Set up Cloud SDK
#         uses: google-github-actions/setup-gcloud@v2
#         if: always()

#       - name: Upload reports to Google Drive using Python
#         if: always()
#         run: |
#           # Instalar dependencias de Python
#           pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

#           # Crear script de Python para subir archivos
#           cat > upload_to_drive.py << 'EOF'
#           import os
#           import json
#           from googleapiclient.discovery import build
#           from googleapiclient.http import MediaFileUpload
#           from google.oauth2 import service_account

#           # Configurar credenciales
#           credentials_json = os.environ.get('GOOGLE_CREDENTIALS')
#           if credentials_json:
#               credentials_info = json.loads(credentials_json)
#               credentials = service_account.Credentials.from_service_account_info(credentials_info)
#           else:
#               # Usar gcloud auth
#               import subprocess
#               token = subprocess.check_output(['gcloud', 'auth', 'print-access-token']).decode().strip()
#               credentials = None  # Usaremos el token directamente

#           # Construir servicio
#           service = build('drive', 'v3', credentials=credentials)

#           folder_id = os.environ.get('FOLDER_ID')

#           # FunciÃ³n para subir archivo
#           def upload_file(file_path, file_name):
#               if os.path.exists(file_path):
#                   file_metadata = {
#                       'name': file_name,
#                       'parents': [folder_id]
#                   }
#                   media = MediaFileUpload(file_path, resumable=True)

#                   try:
#                       file = service.files().create(
#                           body=file_metadata,
#                           media_body=media,
#                           fields='id'
#                       ).execute()
#                       print(f'Archivo {file_name} subido con ID: {file.get("id")}')
#                   except Exception as e:
#                       print(f'Error subiendo {file_name}: {e}')
#               else:
#                   print(f'Archivo {file_path} no encontrado')

#           # Subir archivos
#           upload_file('reports/cucumber-report.html', 'cucumber-report.html')
#           upload_file('reports/cucumber-report.pdf', 'cucumber-report.pdf')
#           EOF

#           # Ejecutar el script
#           python upload_to_drive.py
#         env:
#           GOOGLE_CREDENTIALS: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_KEY }}
#           FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

name: Run Tagged Tests

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Etiqueta de los escenarios a correr (ej: @QR)"
        required: false
        default: "@QR and @Desc"
  schedule:
    - cron: "0 1 * * 1,3"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Run Cucumber tests by tag
        continue-on-error: true
        run: |
          echo "Running scenarios with tag ${{ github.event.inputs.tag }}"
          npx cucumber-js --tags "${{ github.event.inputs.tag }}" --format json:cucumber-report.json
          node reporter.js

      # ðŸ†• CREAR RESUMEN PERSONALIZADO DE TESTS
      - name: Generate Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Resumen de Tests" >> $GITHUB_STEP_SUMMARY

          if [ -f cucumber-report.json ]; then
            # Analizar resultados con Node.js
            cat > analyze-results.js << 'EOF'
            const fs = require('fs');
            
            try {
              const report = JSON.parse(fs.readFileSync('cucumber-report.json', 'utf8'));
              
              let totalScenarios = 0;
              let passedScenarios = 0;
              let failedScenarios = 0;
              let totalSteps = 0;
              let passedSteps = 0;
              let failedSteps = 0;
              let skippedSteps = 0;
              let totalDuration = 0;
              
              const failedTests = [];
              
              report.forEach(feature => {
                if (feature.elements) {
                  feature.elements.forEach(scenario => {
                    totalScenarios++;
                    let scenarioFailed = false;
                    
                    if (scenario.steps) {
                      scenario.steps.forEach(step => {
                        totalSteps++;
                        
                        if (step.result) {
                          if (step.result.duration) {
                            totalDuration += step.result.duration;
                          }
                          
                          switch (step.result.status) {
                            case 'passed':
                              passedSteps++;
                              break;
                            case 'failed':
                              failedSteps++;
                              scenarioFailed = true;
                              break;
                            case 'skipped':
                              skippedSteps++;
                              break;
                          }
                        }
                      });
                    }
                    
                    if (scenarioFailed) {
                      failedScenarios++;
                      failedTests.push({
                        feature: feature.name || 'Feature sin nombre',
                        scenario: scenario.name || 'Escenario sin nombre'
                      });
                    } else {
                      passedScenarios++;
                    }
                  });
                }
              });
              
              const duration = Math.round(totalDuration / 1000000); // nanosegundos a ms
              const successRate = totalScenarios > 0 ? Math.round((passedScenarios / totalScenarios) * 100) : 0;
              
              // Generar tabla de resumen
              console.log('| MÃ©trica | Valor |');
              console.log('|---------|-------|');
              console.log(`| ðŸ“Š **Escenarios Totales** | ${totalScenarios} |`);
              console.log(`| âœ… **Escenarios Exitosos** | ${passedScenarios} |`);
              console.log(`| âŒ **Escenarios Fallidos** | ${failedScenarios} |`);
              console.log(`| ðŸ“ˆ **Tasa de Ã‰xito** | ${successRate}% |`);
              console.log(`| ðŸ”§ **Steps Totales** | ${totalSteps} |`);
              console.log(`| â±ï¸ **DuraciÃ³n Total** | ${duration}ms |`);
              console.log('');
              
              if (failedTests.length > 0) {
                console.log('### âŒ Tests Fallidos:');
                console.log('');
                failedTests.forEach(test => {
                  console.log(`- **${test.feature}** â†’ ${test.scenario}`);
                });
                console.log('');
              }
              
              if (failedScenarios === 0) {
                console.log('### ðŸŽ‰ Â¡Todos los tests pasaron exitosamente!');
              }
              
              // Generar archivo de estado para GitHub
              fs.writeFileSync('test-status.txt', failedScenarios > 0 ? 'FAILED' : 'PASSED');
              
            } catch (error) {
              console.log('âŒ Error analizando resultados:', error.message);
            }
          EOF

            node analyze-results.js >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No se encontrÃ³ cucumber-report.json" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cucumber-html-report
          path: |
            cucumber-report.html
            reports/
            cucumber-report.json

      # ðŸ”’ GOOGLE DRIVE INTEGRATION (COMMENTED OUT)
      # Uncomment the sections below if you want to upload reports to Google Drive

      # - name: Authenticate to Google Cloud
      #   uses: google-github-actions/auth@v2
      #   if: always()
      #   with:
      #     credentials_json: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_KEY }}

      # - name: Set up Cloud SDK
      #   uses: google-github-actions/setup-gcloud@v2
      #   if: always()

      # - name: Upload reports to Google Drive using Python
      #   if: always()
      #   run: |
      #     # Instalar dependencias de Python
      #     pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
      #
      #     # Crear script de Python para subir archivos
      #     cat > upload_to_drive.py << 'EOF'
      #     import os
      #     import json
      #     from googleapiclient.discovery import build
      #     from googleapiclient.http import MediaFileUpload
      #     from google.oauth2 import service_account
      #
      #     # Configurar credenciales
      #     credentials_json = os.environ.get('GOOGLE_CREDENTIALS')
      #     if credentials_json:
      #         credentials_info = json.loads(credentials_json)
      #         credentials = service_account.Credentials.from_service_account_info(credentials_info)
      #     else:
      #         # Usar gcloud auth
      #         import subprocess
      #         token = subprocess.check_output(['gcloud', 'auth', 'print-access-token']).decode().strip()
      #         credentials = None  # Usaremos el token directamente
      #
      #     # Construir servicio
      #     service = build('drive', 'v3', credentials=credentials)
      #
      #     folder_id = os.environ.get('FOLDER_ID')
      #
      #     # FunciÃ³n para subir archivo
      #     def upload_file(file_path, file_name):
      #         if os.path.exists(file_path):
      #             file_metadata = {
      #                 'name': file_name,
      #                 'parents': [folder_id]
      #             }
      #             media = MediaFileUpload(file_path, resumable=True)
      #
      #             try:
      #                 file = service.files().create(
      #                     body=file_metadata,
      #                     media_body=media,
      #                     fields='id'
      #                 ).execute()
      #                 print(f'Archivo {file_name} subido con ID: {file.get("id")}')
      #             except Exception as e:
      #                 print(f'Error subiendo {file_name}: {e}')
      #         else:
      #             print(f'Archivo {file_path} no encontrado')
      #
      #     # Subir archivos
      #     if os.path.exists('reports/'):
      #         upload_file('reports/cucumber-report.html', 'cucumber-report.html')
      #         upload_file('reports/cucumber-report.pdf', 'cucumber-report.pdf')
      #     else:
      #         print('Directorio reports/ no encontrado')
      #     EOF
      #
      #     # Ejecutar el script
      #     python upload_to_drive.py
      #   env:
      #     GOOGLE_CREDENTIALS: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_KEY }}
      #     FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
