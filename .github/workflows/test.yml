name: Run Tagged Tests

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Suite de tests a ejecutar'
        required: true
        default: 'Smoke General'
        type: choice
        options:
          - 'Smoke General'
          - 'Onboarding v1'
          - 'Onboarding v2'
          - 'Orders v1'
          - 'Orders v2'
          - 'Pagos'
          - 'Providers'
          - 'Refunds'
          - 'SintÃ©ticos'
          - 'Withdraw Fiat v1'
          - 'Withdraw Fiat v2'
          - 'Remesas'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Map test suite to tags
        id: map-tags
        run: |
          case "${{ github.event.inputs.test_suite }}" in
            "Smoke General")
              TAGS="@Smoke and @Automated"
              ;;
            "Onboarding v1")
              TAGS="@Onboarding and @Smoke and @Automated"
              ;;
            "Onboarding v2")
              TAGS="@OnboardingV2 and @Smoke and @Automated"
              ;;
            "Orders v1")
              TAGS="@Orders and @Smoke and @V1 and @Automated"
              ;;
            "Orders v2")
              TAGS="@Orders and @Smoke and @V2 and @Automated"
              ;;
            "Pagos")
              TAGS="@QR and @Smoke and @Automated"
              ;;
            "Providers")
              TAGS="@Provider and @Smoke and @Automated"
              ;;
            "Refunds")
              TAGS="@Refunds and @Manual and @Automated"
              ;;
            "SintÃ©ticos")
              TAGS="@Sintetico and @Smoke and @Automated"
              ;;
            "Withdraw Fiat v1")
              TAGS="@Withdraw and @Smoke and @Fiat and @V1 and @Automated"
              ;;
            "Withdraw Fiat v2")
              TAGS="@Withdraw and @Smoke and @Fiat and @V2 and @Automated"
              ;;
            "Remesas")
              TAGS="@Withdraw and @Smoke and @Remesas and @Automated"
              ;;
            *)
              TAGS="@Smoke and @Automated"
              ;;
          esac

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Suite seleccionada: ${{ github.event.inputs.test_suite }}"
          echo "ğŸ“‹ Tags a ejecutar: ${TAGS}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Prepare clean installation
        run: |
          echo "Limpiando solo archivos locales del proyecto..."
          rm -rf node_modules
          rm -f package-lock.json

          echo "Verificando conectividad con CodeArtifact..."
          aws codeartifact describe-repository \
            --domain td \
            --repository backend-shared-libs \
            --region ${{ secrets.AWS_REGION }} \
            --query 'repository.name' \
            --output text

      - name: Configure CodeArtifact authentication
        run: |
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain td \
            --region ${{ secrets.AWS_REGION }} \
            --query authorizationToken \
            --output text)

          CODEARTIFACT_REGISTRY=$(aws codeartifact get-repository-endpoint \
            --domain td \
            --repository backend-shared-libs \
            --format npm \
            --region ${{ secrets.AWS_REGION }} \
            --query repositoryEndpoint \
            --output text)

          echo "registry=${CODEARTIFACT_REGISTRY}" > ~/.npmrc
          echo "${CODEARTIFACT_REGISTRY#https:}:_authToken=${CODEARTIFACT_AUTH_TOKEN}" >> ~/.npmrc
          echo "@md:registry=${CODEARTIFACT_REGISTRY}" >> ~/.npmrc
          echo "fetch-retries=5" >> ~/.npmrc
          echo "fetch-retry-mintimeout=10000" >> ~/.npmrc
          echo "fetch-retry-maxtimeout=60000" >> ~/.npmrc
          echo "fetch-timeout=300000" >> ~/.npmrc

          echo "=== ConfiguraciÃ³n .npmrc ==="
          cat ~/.npmrc

          unset CODEARTIFACT_AUTH_TOKEN

      - name: Smart dependency installation
        run: |
          echo "=== MÃ©todo 1: InstalaciÃ³n estÃ¡ndar ==="
          if npm install --fetch-retries=5 --fetch-retry-mintimeout=10000; then
            echo "âœ… InstalaciÃ³n exitosa con mÃ©todo estÃ¡ndar"
            exit 0
          fi

          echo "=== MÃ©todo 2: ReinstalaciÃ³n desde cero ==="
          rm -rf node_modules
          rm -f package-lock.json

          if npm install --fetch-retries=5 --fetch-retry-mintimeout=10000; then
            echo "âœ… InstalaciÃ³n exitosa con reinstalaciÃ³n"
            exit 0
          fi

          echo "=== MÃ©todo 3: Manejo especÃ­fico del paquete problemÃ¡tico ==="
          if npm info dunder-proto@1.0.1; then
            echo "El paquete existe en el registro, reintentando..."
            npm install dunder-proto@1.0.1 --fetch-retries=5
            npm install --fetch-retries=5
            
            if [ $? -eq 0 ]; then
              echo "âœ… InstalaciÃ³n exitosa con manejo especÃ­fico"
              exit 0
            fi
          fi

          echo "=== MÃ©todo 4: Ãšltimo recurso con cache bypass ==="
          rm -rf node_modules
          rm -f package-lock.json

          if npm install --no-cache --fetch-retries=5; then
            echo "âœ… InstalaciÃ³n exitosa sin cache"
          else
            echo "âŒ Todos los mÃ©todos fallaron"
            echo "InformaciÃ³n de diagnÃ³stico:"
            npm --version
            node --version
            ls -la
            exit 1
          fi

      - name: Run Cucumber tests - ${{ github.event.inputs.test_suite }}
        continue-on-error: true
        run: |
          TAGS="${{ steps.map-tags.outputs.tags }}"

          echo "ğŸ·ï¸ Suite: ${{ github.event.inputs.test_suite }}"
          echo "ğŸ“‹ Ejecutando tests con tags: $TAGS"

          npx cucumber-js --tags "$TAGS" --format json:cucumber-report.json
          node reporter.js

      - name: Generate Test Summary and Prepare Email
        if: always()
        id: test-summary
        run: |
          echo "## ğŸ§ª Resumen de Tests - ${{ github.event.inputs.test_suite }}" >> $GITHUB_STEP_SUMMARY

          if [ -f cucumber-report.json ]; then
            cat > analyze-results.js << 'EOF'
            const fs = require('fs');
            
            try {
              const report = JSON.parse(fs.readFileSync('cucumber-report.json', 'utf8'));
              
              let totalScenarios = 0;
              let passedScenarios = 0;
              let failedScenarios = 0;
              let totalSteps = 0;
              let passedSteps = 0;
              let failedSteps = 0;
              let skippedSteps = 0;
              let totalDuration = 0;
              
              const failedTests = [];
              
              report.forEach(feature => {
                if (feature.elements) {
                  feature.elements.forEach(scenario => {
                    totalScenarios++;
                    let scenarioFailed = false;
                    
                    if (scenario.steps) {
                      scenario.steps.forEach(step => {
                        totalSteps++;
                        
                        if (step.result) {
                          if (step.result.duration) {
                            totalDuration += step.result.duration;
                          }
                          
                          switch (step.result.status) {
                            case 'passed':
                              passedSteps++;
                              break;
                            case 'failed':
                              failedSteps++;
                              scenarioFailed = true;
                              break;
                            case 'skipped':
                              skippedSteps++;
                              break;
                          }
                        }
                      });
                    }
                    
                    if (scenarioFailed) {
                      failedScenarios++;
                      failedTests.push({
                        feature: feature.name || 'Feature sin nombre',
                        scenario: scenario.name || 'Escenario sin nombre'
                      });
                    } else {
                      passedScenarios++;
                    }
                  });
                }
              });
              
              const duration = Math.round(totalDuration / 1000000);
              const successRate = totalScenarios > 0 ? Math.round((passedScenarios / totalScenarios) * 100) : 0;
              
              console.log('| MÃ©trica | Valor |');
              console.log('|---------|-------|');
              console.log(`| ğŸ“Š **Escenarios Totales** | ${totalScenarios} |`);
              console.log(`| âœ… **Escenarios Exitosos** | ${passedScenarios} |`);
              console.log(`| âŒ **Escenarios Fallidos** | ${failedScenarios} |`);
              console.log(`| ğŸ“ˆ **Tasa de Ã‰xito** | ${successRate}% |`);
              console.log(`| ğŸ”§ **Steps Totales** | ${totalSteps} |`);
              console.log(`| â±ï¸ **DuraciÃ³n Total** | ${duration}ms |`);
              console.log('');
              
              if (failedTests.length > 0) {
                console.log('### âŒ Tests Fallidos:');
                console.log('');
                failedTests.forEach(test => {
                  console.log(`- **${test.feature}** â†’ ${test.scenario}`);
                });
                console.log('');
              }
              
              if (failedScenarios === 0) {
                console.log('### ğŸ‰ Â¡Todos los tests pasaron exitosamente!');
              }
              
              const emailData = {
                testStatus: failedScenarios > 0 ? 'TESTS_FAILED' : 'TESTS_PASSED',
                testSuite: process.env.TEST_SUITE || 'Unknown',
                totalScenarios,
                passedScenarios,
                failedScenarios,
                successRate,
                totalSteps,
                duration,
                failedTests,
                timestamp: new Date().toLocaleString('es-ES', { timeZone: 'America/Argentina/Mendoza' })
              };
              
              fs.writeFileSync('test-results.json', JSON.stringify(emailData, null, 2));
                            
            } catch (error) {
              console.log('âŒ Error analizando resultados:', error.message);
              const errorData = {
                testStatus: 'ANALYSIS_ERROR',
                testSuite: process.env.TEST_SUITE || 'Unknown',
                error: error.message,
                timestamp: new Date().toLocaleString('es-ES', { timeZone: 'America/Argentina/Mendoza' })
              };
              require('fs').writeFileSync('test-results.json', JSON.stringify(errorData, null, 2));
            }
          EOF

            TEST_SUITE="${{ github.event.inputs.test_suite }}" node analyze-results.js >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No se encontrÃ³ cucumber-report.json" >> $GITHUB_STEP_SUMMARY
            echo '{"testStatus":"NO_REPORT","testSuite":"${{ github.event.inputs.test_suite }}","timestamp":"'$(date)'","error":"No se encontrÃ³ cucumber-report.json"}' > test-results.json
          fi

      - name: Determine Workflow Status
        if: always()
        id: workflow-status
        run: |
          WORKFLOW_STATUS="SUCCESS"

          if [ ! -f test-results.json ]; then
            WORKFLOW_STATUS="FAILED"
            echo "âš ï¸ No se generaron resultados de tests"
          fi

          echo "workflow_status=${WORKFLOW_STATUS}" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Estado del Workflow: ${WORKFLOW_STATUS}"

      - name: Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          from: ${{ secrets.EMAIL_USERNAME }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          subject: "ğŸ§ª Tests ${{ github.event.inputs.test_suite }} - ${{ github.repository }} [${{ steps.workflow-status.outputs.workflow_status || 'UNKNOWN' }}]"
          body: |
            Hola!

            Se ejecutaron los tests de la suite "${{ github.event.inputs.test_suite }}" en el repositorio ${{ github.repository }}

            ğŸ“Š Estado del Workflow: ${{ steps.workflow-status.outputs.workflow_status || 'UNKNOWN' }}
            ğŸ·ï¸ Suite ejecutada: ${{ github.event.inputs.test_suite }}
            ğŸ“‹ Tags utilizados: ${{ steps.map-tags.outputs.tags }}

            El workflow de GitHub Actions ${{ steps.workflow-status.outputs.workflow_status == 'SUCCESS' && 'se completÃ³ exitosamente' || 'fallÃ³ durante la ejecuciÃ³n' }}.

            ğŸ”— Ver resultados completos:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ğŸ“Š Resumen de tests disponible en la pestaÃ±a "Summary" del workflow.

            ---
            Generado automÃ¡ticamente por GitHub Actions

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cucumber-html-report-${{ github.event.inputs.test_suite }}
          path: |
            cucumber-report.html
            reports/
            cucumber-report.json
            test-results.json
